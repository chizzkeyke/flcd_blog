import React, { useState, useEffect } from 'react'
import { Link, Redirect } from 'react-router-dom'
import { useSelector, useDispatch } from 'react-redux'
import { fetchUserData } from 'DAL/authFetch'
import { fetchDataAboutCurrentUser } from 'DAL/userFetch'

import Loader from 'components/Loader'

import './style.css'

const Auth = props => {
   const [name, setName] = useState('')
   const [email, setEmail] = useState('')
   const [password, setPassword] = useState('')
   const [confirmPassword, setConfirmPassword] = useState('')
   const [submit, setSubmit] = useState(false)

   const loading = useSelector(state => state.auth.loading)
   const isLoggedIn = useSelector(state => state.auth.loggedIn)
   const dispatch = useDispatch()

   const path = props.match.path === '/register'
   const titlePage = path ? 'Register' : 'Login'
   const btnHandle = path ? 'Sign Up' : 'Sign In'
   const handleLink = path ? '/login' : '/register'
   const handleLinkText = path ? 'Have account ?' : 'Not have account ?'
   const urlFetching = path ? 'register' : 'token'
   const options = path
      ? { name, email, password, password_confirmation: confirmPassword }
      : { email, password }

   useEffect(() => {
      if (!submit) {
         return
      }
      dispatch(fetchUserData(options, urlFetching))
      dispatch(fetchDataAboutCurrentUser())
      setSubmit(false)
   })

   const handleSubmit = e => {
      e.preventDefault()
      setSubmit(true)
   }

   if (isLoggedIn) {
      return <Redirect to='/' />
   }

   return (
      <div>
         {
            loading
               ? <Loader />
               : (
                  <div className='auth'>
                     <h1 className='title'>{titlePage}</h1>
                     <form className='form' onSubmit={handleSubmit}>
                        {!!path && (
                           <div className='div_input'>
                              <span>Name</span>
                              <input
                                 type='text'
                                 value={name}
                                 onChange={e => setName(e.target.value)}
                              />
                           </div>
                        )}
                        <div className='div_input'>
                           <span>Email</span>
                           <input
                              type='email'
                              value={email}
                              onChange={e => setEmail(e.target.value)}
                           />
                        </div>
                        <div className='div_input'>
                           <span>Password</span>
                           <input
                              type='password'
                              value={password}
                              onChange={e => setPassword(e.target.value)}
                           />
                        </div>
                        {!!path && (
                           <div className='div_input'>
                              <span>Confirm Password</span>
                              <input
                                 type='password'
                                 value={confirmPassword}
                                 onChange={e => setConfirmPassword(e.target.value)}
                              />
                           </div>
                        )}
                        <button className='btn_form' >{btnHandle}</button>
                        <Link to={handleLink}>{handleLinkText}</Link>
                     </form>
                  </div>
               )
         }
      </div>
   )
}

export default Auth