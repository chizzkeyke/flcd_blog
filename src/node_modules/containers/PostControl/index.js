import React, { useEffect } from 'react'
import { useSelector, useDispatch } from 'react-redux'
import { getOnePost, fetchDeletePost } from 'DAL/postsFetching'
import { fetchComments } from 'DAL/commentsFetch'
import { clearOnePost } from 'redux/actions/posts'
import { clearComments } from 'redux/actions/comments'
import Loader from 'components/Loader'
import Comment from 'components/Comment'
import { Link } from 'react-router-dom'
import { useHistory } from 'react-router-dom'

const PostControl = (props) => {
   const postId = props.match.params.slug
   const post = useSelector(state => state.post.post)
   const comments = useSelector(state => state.comment.commentsSelectedPost)
   const userId = useSelector(state => state.user.currentUserData.id)
   const history = useHistory()
   const dispatch = useDispatch()

   useEffect(() => {
      dispatch(getOnePost(postId))
      dispatch(fetchComments(postId))
      return () => {
         dispatch(clearOnePost())
         dispatch(clearComments())
      }
   }, [dispatch])

   const deletePost = () => {
      dispatch(fetchDeletePost(postId))
      setTimeout(() => {
         history.push('/myposts')
      }, 2000)
   }

   return (
      <div className='post_control'>
         {
            post && comments
               ? (
                  <div>
                     <h3>Пост {postId}</h3>
                     <p>{post.text}</p>
                     <p>Дата создания {post.created_at}</p>
                     <p>Пользователь №{post.user_id}</p>
                     {userId === post.user_id && (
                        <div>
                           <button onClick={deletePost}>delete</button>
                           {/* <button onClick={redirectUpdatePost}>update</button> */}
                           <Link to={`/updatePost/${postId}`}><button>Update</button></Link>
                        </div>
                     )}
                     {comments.map(comment => (
                        <Comment 
                           text={comment.text} 
                           user_id={comment.user_id}
                        />
                     ))}
                  </div>
               )
               : (
                  <Loader />
               )
         }
      </div>
   )
}

export default PostControl
